<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã - –ú–∞–∫–µ—Ç</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f4f6f8; color: #333; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; color: #1976d2; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .tabs { display: flex; border-bottom: 2px solid #1976d2; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; margin-right: 5px; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .tab-button:hover { background-color: #e3f2fd; }
        .tab-button.active { color: #1976d2; border-bottom: 2px solid #1976d2; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-section, .filter-panel { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        .form-section h2, .filter-panel h2 { font-size: 18px; margin-top: 0; margin-bottom: 15px; color: #555; }
        .form-section h3 { font-size: 16px; margin-top: 20px; margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input[type="text"], .form-group input[type="tel"], .form-group input[type="password"], .form-group input[type="number"], .form-group input[type="date"], .form-group input[type="url"], .form-group select {
            width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;
        }
        .form-group input[type="checkbox"] { margin-right: 5px; vertical-align: middle; }

        .button { padding: 10px 15px; font-size: 14px; border-radius: 4px; border: none; cursor: pointer; transition: background-color 0.2s ease; margin-right: 10px; text-decoration: none; display: inline-block; }
        .button-primary { background-color: #1976d2; color: white; } .button-primary:hover { background-color: #1565c0; }
        .button-secondary { background-color: #dc004e; color: white; } .button-secondary:hover { background-color: #b2003f; }
        .button-outlined { background-color: transparent; color: #1976d2; border: 1px solid #1976d2; } .button-outlined:hover { background-color: rgba(25, 118, 210, 0.04); }
        .button-small { padding: 6px 10px; font-size: 13px; }

        .icon-button { background: none; border: none; cursor: pointer; padding: 5px; font-size: 18px; color: #555; margin: 0 2px; vertical-align: middle; }
        .icon-button:hover { color: #1976d2; }
        .icon-button.danger { color: #777; } .icon-button.danger:hover { color: #dc004e; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; }
        th { background-color: #eef; font-weight: 600; }
        tr:nth-child(even) { background-color: #f9f9f9; } tr:hover { background-color: #f1f1f1; }
        .actions-cell button:first-child { margin-left: 0; } .actions-cell button:last-child { margin-right: 0; }

        .hidden { display: none !important; }
        .flex-container { display: flex; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px; }
        .flex-item-grow { flex-grow: 1; margin-right: 10px; min-width: 150px; }
        .flex-item-auto { margin-left: auto; }

        /* Branch specific styles */
        .branches-section { margin-top: 25px; padding-top: 15px; border-top: 1px solid #e0e0e0; }

        .attached-branch-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }
        .attached-branch-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
        }
        .attached-branch-list li span {
            flex-grow: 1;
        }

        .add-branch-control-group { /* –î–ª—è select –∏ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–≤—è–∑–∞—Ç—å" */
            display: flex;
            align-items: flex-end;
            border-top: 1px dashed #ddd;
            padding-top:15px;
            margin-top: 15px;
        }
        .add-branch-control-group .form-group {
            flex-grow: 1;
            margin-bottom: 0;
            margin-right: 10px;
        }
        .add-branch-control-group .button {
            margin-bottom: 0;
            white-space: nowrap; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h1>
    <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'legalEntitiesTab')">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ª–∏—Ü–∞</button>
        <button class="tab-button" onclick="openTab(event, 'contractsTab')">–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</button>
    </div>

    <div id="legalEntitiesTab" class="tab-content active">
        <div class="filter-panel">
            <h2>–§–∏–ª—å—Ç—Ä –∏ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div class="flex-container">
                <div class="form-group flex-item-grow">
                    <label for="leCompanyFilter">–ö–æ–º–ø–∞–Ω–∏—è:</label>
                    <select id="leCompanyFilter">
                        <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
                        <option value="1">–û–û–û "–†–æ–º–∞—à–∫–∞"</option>
                        <option value="2">–ò–ü "–í–∞—Å–∏–ª–µ–∫"</option>
                    </select>
                </div>
                <button class="button button-primary" onclick="applyLeFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="button button-secondary flex-item-auto" onclick="showLeForm('add')">–î–æ–±–∞–≤–∏—Ç—å –Æ–† –ª–∏—Ü–æ</button>
            </div>
        </div>
        <div id="leListSection">
            <h2>–°–ø–∏—Å–æ–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü</h2>
            <table>
                <thead>
                <tr>
                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                    <th>–¢–∏–ø –Æ–† –ª–∏—Ü–∞</th>
                    <th>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
                    <th>–¢–µ–ª</th>
                    <th>–û—Å–Ω–æ–≤–Ω–æ–π</th>
                    <th>–¢–æ–∫–µ–Ω</th>
                    <th>–ë–∞–ª–∞–Ω—Å TrustMe</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>–û–û–û "–†–æ–º–∞—à–∫–∞"</td>
                    <td>–¢–û–û</td>
                    <td>–ò–≤–∞–Ω–æ–≤ –ò.–ò.</td>
                    <td>+79001234567</td>
                    <td><input type="checkbox" checked disabled></td>
                    <td><span>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></td>
                    <td>15000.00</td>
                    <td class="actions-cell">
                        <button class="icon-button" title="–ü—Ä–æ—Å–º–æ—Ç—Ä" onclick="viewLeDetails(1)">üîé</button>
                        <button class="icon-button" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="showLeForm('edit', 1)">‚úèÔ∏è</button>
                        <button class="icon-button danger" title="–£–¥–∞–ª–∏—Ç—å" onclick="deleteItem('–Æ–õ', 1)">üóëÔ∏è</button>
                    </td>
                </tr>
                <tr>
                    <td>–ò–ü "–í–∞—Å–∏–ª–µ–∫"</td>
                    <td>–ò–ü</td>
                    <td>–ü–µ—Ç—Ä–æ–≤ –ü.–ü.</td>
                    <td>+79017654321</td>
                    <td><input type="checkbox" disabled></td>
                    <td><span>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></td>
                    <td>5300.50</td>
                    <td class="actions-cell">
                        <button class="icon-button" title="–ü—Ä–æ—Å–º–æ—Ç—Ä" onclick="viewLeDetails(2)">üîé</button>
                        <button class="icon-button" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="showLeForm('edit', 2)">‚úèÔ∏è</button>
                        <button class="icon-button danger" title="–£–¥–∞–ª–∏—Ç—å" onclick="deleteItem('–Æ–õ', 2)">üóëÔ∏è</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="leFormSection" class="form-section hidden">
            <h2 id="leFormTitle">–î–æ–±–∞–≤–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</h2>
            <input type="hidden" id="leId">
            <div class="form-group">
                <label for="leCompany">–ö–æ–º–ø–∞–Ω–∏—è:</label>
                <select id="leCompany">
                    <option value="–û–û–û –†–æ–º–∞—à–∫–∞">–û–û–û "–†–æ–º–∞—à–∫–∞"</option>
                    <option value="–ò–ü –í–∞—Å–∏–ª–µ–∫">–ò–ü "–í–∞—Å–∏–ª–µ–∫"</option>
                </select>
            </div>
            <div class="form-group">
                <label for="leName">–ù–∞–∑–≤–∞–Ω–∏–µ –Æ–õ:</label>
                <input type="text" id="leName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Æ–õ">
            </div>
            <div class="form-group">
                <label for="leType">–¢–∏–ø –Æ–† –ª–∏—Ü–∞:</label>
                <select id="leType">
                    <option value="–¢–û–û">–¢–û–û</option>
                    <option value="–ò–ü">–ò–ü</option>
                </select>
            </div>
            <div class="form-group">
                <label for="leDirector">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:</label>
                <input type="text" id="leDirector" placeholder="–§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è">
            </div>
            <div class="form-group">
                <label for="lePhone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="tel" id="lePhone" placeholder="+7 XXX XXX XX XX">
            </div>
            <div class="form-group">
                <label for="leToken">–¢–æ–∫–µ–Ω TrustMe:</label>
                <input type="password" id="leToken" placeholder="–¢–æ–∫–µ–Ω">
            </div>
            <div class="form-group">
                <label for="leBalance">–ë–∞–ª–∞–Ω—Å TrustMe:</label>
                <input type="number" id="leBalance" placeholder="0.00">
            </div>
            <div class="form-group">
                <input type="checkbox" id="leIsPrimary">
                <label for="leIsPrimary" style="display: inline;">–û—Å–Ω–æ–≤–Ω–æ–µ –Æ–õ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏</label>
            </div>

            <div id="leBranchesSection" class="branches-section hidden">
                <h3>–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª—ã</h3>
                <ul id="attachedBranchListUl" class="attached-branch-list">
                    {/* –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª—ã */}
                </ul>

                <div class="add-branch-control-group">
                    <div class="form-group">
                        <label for="availableBranchesSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</label>
                        <select id="availableBranchesSelect">
                            {/* –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ JS */}
                        </select>
                    </div>
                    <button type="button" class="button button-outlined button-small" onclick="attachBranch()">–ü—Ä–∏–≤—è–∑–∞—Ç—å —Ñ–∏–ª–∏–∞–ª</button>
                </div>
            </div>

            <div>
                <button class="button button-primary" onclick="saveLeForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="button button-outlined" onclick="hideLeForm()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="contractsTab" class="tab-content">
        <div class="filter-panel">
            <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div class="flex-container">
                <div class="form-group flex-item-grow">
                    <label for="contractCompanyFilter">–ö–æ–º–ø–∞–Ω–∏—è:</label>
                    <select id="contractCompanyFilter">
                        <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
                        <option value="1">–û–û–û "–†–æ–º–∞—à–∫–∞"</option>
                        <option value="2">–ò–ü "–í–∞—Å–∏–ª–µ–∫"</option>
                        <option value="3">–û–û–û "–ê–ª—å—Ñ–∞"</option>
                        <option value="4">–ê–û "–ë–µ—Ç–∞ –ì—Ä—É–ø–ø"</option>
                    </select>
                </div>
                <button class="button button-primary" onclick="applyContractFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="button button-secondary flex-item-auto" onclick="showContractForm('add')">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç</button>
            </div>
        </div>
        <div id="contractListSection">
            <table>
                <thead>
                <tr>
                    <th>–ö–æ–º–ø–∞–Ω–∏—è 1</th>
                    <th>–Æ–õ –∫–æ–º–ø. 1</th>
                    <th>–ö–æ–º–ø–∞–Ω–∏—è 2</th>
                    <th>–Æ–õ –∫–æ–º–ø. 2</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°—Å—ã–ª–∫–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>–û–û–û "–†–æ–º–∞—à–∫–∞"</td>
                    <td>–¢–û–û "–†–æ–º–∞—à–∫–∞ –û—Å–Ω–æ–≤–Ω–æ–µ"</td>
                    <td>–ò–ü "–í–∞—Å–∏–ª–µ–∫"</td>
                    <td>–ò–ü "–í–∞—Å–∏–ª–µ–∫ –ì–ª–∞–≤–Ω–æ–µ"</td>
                    <td>–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏ ‚Ññ123</td>
                    <td>01.06.2023</td>
                    <td><a href="#" class="button" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></td>
                    <td class="actions-cell">
                        <button class="icon-button" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="showContractForm('edit', 1)">‚úèÔ∏è</button>
                        <button class="icon-button danger" title="–£–¥–∞–ª–∏—Ç—å" onclick="deleteItem('–ö–æ–Ω—Ç—Ä–∞–∫—Ç', 1)">üóëÔ∏è</button>
                    </td>
                </tr>
                <tr>
                    <td>–û–û–û "–ê–ª—å—Ñ–∞"</td>
                    <td>–¢–û–û "–ê–ª—å—Ñ–∞-–°–µ—Ä–≤–∏—Å"</td>
                    <td>–ê–û "–ë–µ—Ç–∞ –ì—Ä—É–ø–ø"</td>
                    <td>–ê–û "–ë–µ—Ç–∞ –ì—Ä—É–ø–ø"</td>
                    <td>–°–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–µ</td>
                    <td>15.05.2024</td>
                    <td><a href="#" class="button" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></td>
                    <td class="actions-cell">
                        <button class="icon-button" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="showContractForm('edit', 2)">‚úèÔ∏è</button>
                        <button class="icon-button danger" title="–£–¥–∞–ª–∏—Ç—å" onclick="deleteItem('–ö–æ–Ω—Ç—Ä–∞–∫—Ç', 2)">üóëÔ∏è</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="contractFormSection" class="form-section hidden">
            <h2 id="contractFormTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç</h2>
            <input type="hidden" id="contractId">
            <div class="form-group">
                <label for="contractCompany1">–ö–æ–º–ø–∞–Ω–∏—è 1:</label>
                <select id="contractCompany1">
                    <option value="–û–û–û –†–æ–º–∞—à–∫–∞">–û–û–û "–†–æ–º–∞—à–∫–∞"</option>
                    <option value="–ò–ü –í–∞—Å–∏–ª–µ–∫">–ò–ü "–í–∞—Å–∏–ª–µ–∫"</option>
                    <option value="–û–û–û –ê–ª—å—Ñ–∞">–û–û–û "–ê–ª—å—Ñ–∞"</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contractLe1">–Æ–õ –ö–æ–º–ø–∞–Ω–∏–∏ 1:</label>
                <input type="text" id="contractLe1" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –≤—ã–±–æ—Ä" value="–¢–û–û –†–æ–º–∞—à–∫–∞ –û—Å–Ω–æ–≤–Ω–æ–µ" readonly>
            </div>
            <div class="form-group">
                <label for="contractCompany2">–ö–æ–º–ø–∞–Ω–∏—è 2:</label>
                <select id="contractCompany2">
                    <option value="–û–û–û –†–æ–º–∞—à–∫–∞">–û–û–û "–†–æ–º–∞—à–∫–∞"</option>
                    <option value="–ò–ü –í–∞—Å–∏–ª–µ–∫">–ò–ü "–í–∞—Å–∏–ª–µ–∫"</option>
                    <option value="–ê–û –ë–µ—Ç–∞ –ì—Ä—É–ø–ø">–ê–û "–ë–µ—Ç–∞ –ì—Ä—É–ø–ø"</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contractLe2">–Æ–õ –ö–æ–º–ø–∞–Ω–∏–∏ 2:</label>
                <input type="text" id="contractLe2" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –≤—ã–±–æ—Ä" value="–ò–ü –í–∞—Å–∏–ª–µ–∫ –ì–ª–∞–≤–Ω–æ–µ" readonly>
            </div>
            <div class="form-group">
                <label for="contractName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:</label>
                <input type="text" id="contractName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞">
            </div>
            <div class="form-group">
                <label for="contractDate">–î–∞—Ç–∞ –∑–∞–∫–ª—é—á–µ–Ω–∏—è:</label>
                <input type="date" id="contractDate">
            </div>
            <div class="form-group">
                <label for="contractLink">–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç:</label>
                <input type="url" id="contractLink" placeholder="https://example.com/doc.pdf">
            </div>
            <div>
                <button class="button button-primary" onclick="saveContractForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="button button-outlined" onclick="hideContractForm()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Tab Management ---
    function openTab(event, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).classList.add("active");
        event.currentTarget.classList.add("active");
    }

    // --- Legal Entity (LE) Form Management ---
    const leListSection = document.getElementById('leListSection');
    const leFormSection = document.getElementById('leFormSection');
    const leFormTitle = document.getElementById('leFormTitle');
    const leIdInput = document.getElementById('leId');
    const leNameInput = document.getElementById('leName');
    const leCompanySelect = document.getElementById('leCompany');
    const leTypeSelect = document.getElementById('leType');
    const leDirectorInput = document.getElementById('leDirector');
    const lePhoneInput = document.getElementById('lePhone');
    const leTokenInput = document.getElementById('leToken');
    const leBalanceInput = document.getElementById('leBalance');
    const leIsPrimaryCheckbox = document.getElementById('leIsPrimary');


    const leBranchesSection = document.getElementById('leBranchesSection');
    const attachedBranchListUl = document.getElementById('attachedBranchListUl');
    const availableBranchesSelect = document.getElementById('availableBranchesSelect');

    let currentAttachedBranches = [];

    const allBranchesDirectory = [
        { id: 'branch_alpha', name: '–§–∏–ª–∏–∞–ª –ê–ª—å—Ñ–∞ (–ú–æ—Å–∫–≤–∞)' },
        { id: 'branch_beta', name: '–§–∏–ª–∏–∞–ª –ë–µ—Ç–∞ (–°–ü–±)' },
        { id: 'branch_gamma', name: '–§–∏–ª–∏–∞–ª –ì–∞–º–º–∞ (–ï–∫–±)' },
        { id: 'branch_delta', name: '–§–∏–ª–∏–∞–ª –î–µ–ª—å—Ç–∞ (–ù—Å–∫)' },
        { id: 'branch_epsilon', name: '–§–∏–ª–∏–∞–ª –≠–ø—Å–∏–ª–æ–Ω (–ö–∞–∑–∞–Ω—å)' }
    ];

    const mockLegalEntitiesData = {
        1: {
            id: 1, name: '–û–û–û "–†–æ–º–∞—à–∫–∞"', company: '–û–û–û –†–æ–º–∞—à–∫–∞', type: '–¢–û–û', director: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.',
            phone: '+79001234567', token: 'token1', balance: '15000.00', isPrimary: true,
            attachedBranchIds: ['branch_alpha', 'branch_gamma']
        },
        2: {
            id: 2, name: '–ò–ü "–í–∞—Å–∏–ª–µ–∫"', company: '–ò–ü –í–∞—Å–∏–ª–µ–∫', type: '–ò–ü', director: '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.',
            phone: '+79017654321', token: 'token2', balance: '5300.50', isPrimary: false,
            attachedBranchIds: []
        }
    };

    function showLeForm(mode, entityId = null) {
        leListSection.classList.add('hidden');
        leFormSection.classList.remove('hidden');
        leFormSection.scrollIntoView({ behavior: 'smooth' });
        currentAttachedBranches = [];

        if (mode === 'add') {
            leFormTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ';
            leIdInput.value = '';
            leNameInput.value = '';
            leCompanySelect.value = leCompanySelect.options[0].value;
            leTypeSelect.value = leTypeSelect.options[0].value;
            leDirectorInput.value = '';
            lePhoneInput.value = '';
            leTokenInput.value = '';
            leBalanceInput.value = '';
            leIsPrimaryCheckbox.checked = false;
            leBranchesSection.classList.remove('hidden');
        } else if (mode === 'edit' && entityId) {
            leFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ (ID: ${entityId})`;
            leIdInput.value = entityId;
            const entityData = mockLegalEntitiesData[entityId];
            if (entityData) {
                leNameInput.value = entityData.name;
                leCompanySelect.value = entityData.company;
                leTypeSelect.value = entityData.type;
                leDirectorInput.value = entityData.director;
                lePhoneInput.value = entityData.phone;
                leTokenInput.value = entityData.token; // In real app, handle token carefully
                leBalanceInput.value = entityData.balance;
                leIsPrimaryCheckbox.checked = entityData.isPrimary;

                (entityData.attachedBranchIds || []).forEach(branchId => {
                    const branchInfo = allBranchesDirectory.find(b => b.id === branchId);
                    if (branchInfo) {
                        currentAttachedBranches.push({ ...branchInfo });
                    }
                });
            } else {
                console.warn(`–î–∞–Ω–Ω—ã–µ –¥–ª—è –Æ–õ ID: ${entityId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`);
                // –ú–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                leFormTitle.textContent = '–û—à–∏–±–∫–∞: –Æ–õ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
            }
            leBranchesSection.classList.remove('hidden');
        }
        renderAttachedBranchList();
        populateAvailableBranchesSelect();
    }

    function hideLeForm() {
        leFormSection.classList.add('hidden');
        leListSection.classList.remove('hidden');
        currentAttachedBranches = [];
    }

    function saveLeForm() {
        if (!leNameInput.value.trim()) { alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Æ–õ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.'); leNameInput.focus(); return; }
        const id = leIdInput.value;
        const leData = {
            id: id ? parseInt(id) : null, // Keep original ID or null for new
            name: leNameInput.value,
            company: leCompanySelect.value,
            type: leTypeSelect.value,
            director: leDirectorInput.value,
            phone: lePhoneInput.value,
            token: leTokenInput.value,
            balance: leBalanceInput.value,
            isPrimary: leIsPrimaryCheckbox.checked,
            attachedBranchIds: currentAttachedBranches.map(branch => branch.id)
        };

        if (leData.id) { // Existing entity
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Æ–õ ID:', leData.id, leData);
            alert(`–Æ–õ (ID: ${leData.id}) —Å –ø—Ä–∏–≤—è–∑–∫–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (—Å–∏–º—É–ª—è—Ü–∏—è).`);
            mockLegalEntitiesData[leData.id] = JSON.parse(JSON.stringify(leData));
        } else { // New entity
            const newId = Math.max(0, ...Object.keys(mockLegalEntitiesData).map(Number)) + 1;
            leData.id = newId;
            console.log('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –Æ–õ ID:', newId, leData);
            alert(`–ù–æ–≤–æ–µ –Æ–õ (ID: ${newId}) –¥–æ–±–∞–≤–ª–µ–Ω–æ (—Å–∏–º—É–ª—è—Ü–∏—è).`);
            mockLegalEntitiesData[newId] = JSON.parse(JSON.stringify(leData));
        }
        hideLeForm();
        // TODO: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –Æ–õ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
    }

    function applyLeFilter() { alert('–§–∏–ª—å—Ç—Ä –Æ–õ –ø—Ä–∏–º–µ–Ω–µ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è).'); }

    function viewLeDetails(entityId) {
        const entityData = mockLegalEntitiesData[entityId];
        if (!entityData) {
            alert(`–Æ–õ —Å ID ${entityId} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.`);
            return;
        }
        let details = `–ü—Ä–æ—Å–º–æ—Ç—Ä –Æ–õ (ID: ${entityId}):\n`;
        details += `–ù–∞–∑–≤–∞–Ω–∏–µ: ${entityData.name}\n`;
        details += `–ö–æ–º–ø–∞–Ω–∏—è: ${entityData.company}\n`;
        details += `–¢–∏–ø: ${entityData.type}\n`;
        details += `–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: ${entityData.director}\n`;
        // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

        if (entityData.attachedBranchIds && entityData.attachedBranchIds.length > 0) {
            details += "\n–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª—ã:\n";
            entityData.attachedBranchIds.forEach(branchId => {
                const branchInfo = allBranchesDirectory.find(b => b.id === branchId);
                details += `  - ${branchInfo ? branchInfo.name : ('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∏–ª–∏–∞–ª ID: ' + branchId)}\n`;
            });
        } else { details += "\n–§–∏–ª–∏–∞–ª—ã –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã.\n"; }
        alert(details);
    }

    function renderAttachedBranchList() {
        attachedBranchListUl.innerHTML = '';
        currentAttachedBranches.forEach(branch => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.textContent = branch.name;

            const removeButton = document.createElement('button');
            removeButton.className = 'icon-button danger';
            removeButton.title = '–û—Ç–≤—è–∑–∞—Ç—å —Ñ–∏–ª–∏–∞–ª';
            removeButton.innerHTML = '‚úñ';
            removeButton.onclick = function() { detachBranch(branch.id); };

            li.appendChild(span);
            li.appendChild(removeButton);
            attachedBranchListUl.appendChild(li);
        });
    }

    function populateAvailableBranchesSelect() {
        availableBranchesSelect.innerHTML = ''; // Clear previous options
        let hasAvailableOptions = false;
        const attachedIds = currentAttachedBranches.map(b => b.id);

        allBranchesDirectory.forEach(branch => {
            if (!attachedIds.includes(branch.id)) {
                if (!hasAvailableOptions) { // Add placeholder only if there are actual options
                    const placeholderOption = document.createElement('option');
                    placeholderOption.value = "";
                    placeholderOption.textContent = "-- –í—ã–±–µ—Ä–∏—Ç–µ --";
                    availableBranchesSelect.appendChild(placeholderOption);
                    hasAvailableOptions = true;
                }
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name;
                availableBranchesSelect.appendChild(option);
            }
        });

        if (!hasAvailableOptions) {
            const noOpt = document.createElement('option');
            noOpt.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤";
            noOpt.disabled = true;
            availableBranchesSelect.appendChild(noOpt);
            availableBranchesSelect.disabled = true;
        } else {
            availableBranchesSelect.disabled = false;
        }
    }

    function attachBranch() {
        const selectedBranchId = availableBranchesSelect.value;
        if (!selectedBranchId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞.');
            return;
        }

        const branchInfo = allBranchesDirectory.find(b => b.id === selectedBranchId);
        if (branchInfo && !currentAttachedBranches.some(b => b.id === selectedBranchId)) {
            currentAttachedBranches.push({ ...branchInfo });
            renderAttachedBranchList();
            populateAvailableBranchesSelect();
        }
    }

    function detachBranch(branchId) {
        if (confirm('–û—Ç–≤—è–∑–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª–∏–∞–ª?')) {
            currentAttachedBranches = currentAttachedBranches.filter(branch => branch.id !== branchId);
            renderAttachedBranchList();
            populateAvailableBranchesSelect();
        }
    }

    // --- Contract Form Management ---
    const contractListSection = document.getElementById('contractListSection');
    const contractFormSection = document.getElementById('contractFormSection');
    const contractFormTitle = document.getElementById('contractFormTitle');
    const contractIdInput = document.getElementById('contractId');
    const contractCompany1Select = document.getElementById('contractCompany1');
    const contractLe1Input = document.getElementById('contractLe1');
    const contractCompany2Select = document.getElementById('contractCompany2');
    const contractLe2Input = document.getElementById('contractLe2');
    const contractNameInput = document.getElementById('contractName');
    const contractDateInput = document.getElementById('contractDate');
    const contractLinkInput = document.getElementById('contractLink');

    function showContractForm(mode, id = null) {
        contractListSection.classList.add('hidden');
        contractFormSection.classList.remove('hidden');
        contractFormSection.scrollIntoView({ behavior: 'smooth' });
        if (mode === 'add') {
            contractFormTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç';
            contractIdInput.value = '';
            [contractNameInput, contractDateInput, contractLinkInput].forEach(input => input.value = '');
            contractCompany1Select.value = contractCompany1Select.options[0].value;
            contractLe1Input.value = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ö–æ–º–ø–∞–Ω–∏–∏ 1';
            contractCompany2Select.value = contractCompany2Select.options[0].value;
            contractLe2Input.value = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ö–æ–º–ø–∞–Ω–∏–∏ 2';
        } else if (mode === 'edit' && id) {
            contractFormTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç (ID: ${id})`;
            contractIdInput.value = id;
            // Simulate loading data for contract
            contractNameInput.value = id === 1 ? '–î–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏ ‚Ññ123' : '–°–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–µ';
            contractDateInput.value = id === 1 ? '2023-06-01' : '2024-05-15';
            contractLinkInput.value = 'https://example.com/doc.pdf';
            contractCompany1Select.value = id === 1 ? '–û–û–û –†–æ–º–∞—à–∫–∞' : '–û–û–û –ê–ª—å—Ñ–∞';
            contractLe1Input.value = id === 1 ? '–¢–û–û –†–æ–º–∞—à–∫–∞ –û—Å–Ω–æ–≤–Ω–æ–µ' : '–¢–û–û –ê–ª—å—Ñ–∞-–°–µ—Ä–≤–∏—Å';
            contractCompany2Select.value = id === 1 ? '–ò–ü –í–∞—Å–∏–ª–µ–∫' : '–ê–û –ë–µ—Ç–∞ –ì—Ä—É–ø–ø';
            contractLe2Input.value = id === 1 ? '–ò–ü –í–∞—Å–∏–ª–µ–∫ –ì–ª–∞–≤–Ω–æ–µ' : '–ê–û –ë–µ—Ç–∞ –ì—Ä—É–ø–ø';
        }
    }
    function hideContractForm() {
        contractFormSection.classList.add('hidden');
        contractListSection.classList.remove('hidden');
    }
    function saveContractForm() {
        if (!contractNameInput.value.trim()) {
            alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.');
            contractNameInput.focus();
            return;
        }
        const id = contractIdInput.value;
        const contractData = {
            company1: contractCompany1Select.value, le1: contractLe1Input.value,
            company2: contractCompany2Select.value, le2: contractLe2Input.value,
            name: contractNameInput.value, date: contractDateInput.value, link: contractLinkInput.value,
        };
        if (id) {
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞ ID:', id, contractData);
            alert(`–ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (ID: ${id}) —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (—Å–∏–º—É–ª—è—Ü–∏—è).`);
        } else {
            console.log('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞:', contractData);
            alert('–ù–æ–≤—ã–π –ö–æ–Ω—Ç—Ä–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è).');
        }
        hideContractForm();
    }
    function applyContractFilter() {
        const companyFilterValue = document.getElementById('contractCompanyFilter').value;
        const companyFilterText = document.getElementById('contractCompanyFilter').selectedOptions[0].text;
        alert(`–ü—Ä–∏–º–µ–Ω–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏: ${companyFilterValue ? companyFilterText : '–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏'} (—Å–∏–º—É–ª—è—Ü–∏—è).`);
    }

    // --- Common Actions ---
    function deleteItem(itemType, id) {
        if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${itemType} (ID: ${id})?`)) {
            console.log(`–£–¥–∞–ª–µ–Ω–∏–µ ${itemType} ID: ${id}`);
            alert(`${itemType} (ID: ${id}) —É–¥–∞–ª–µ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è).`);
            if (itemType === '–Æ–õ' && mockLegalEntitiesData[id]) {
                delete mockLegalEntitiesData[id];
                // TODO: –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –Æ–õ –Ω–∞ UI
            }
            // TODO: –î–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –µ—Å–ª–∏ –±—É–¥–µ—Ç mock data –¥–ª—è –Ω–∏—Ö
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure the first tab is active by default
        const firstTabButton = document.querySelector('.tab-button');
        if(firstTabButton) {
            openTab({ currentTarget: firstTabButton }, firstTabButton.getAttribute('onclick').match(/'([^']+)'/)[1]);
        }
    });
</script>
</body>
</html>s